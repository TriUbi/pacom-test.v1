@page "/login"
@inject HttpClient Http
@inject NavigationManager Nav
@inject IJSRuntime JS
@using DeviceFrontend.Helpers
@rendermode InteractiveServer

<h3>üîê Logga in</h3>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <p class="text-danger">@errorMessage</p>
}

<div class="mb-3">
    <input class="form-control" placeholder="Anv√§ndarnamn" @bind="username" />
</div>
<div class="mb-3">
    <input class="form-control" type="password" placeholder="L√∂senord" @bind="password" />
</div>
<button class="btn btn-primary" @onclick="PerformLogin">Logga in</button>

@code {
    private string username = "";
    private string password = "";
    private string? errorMessage;

    private async Task PerformLogin()
    {

    Console.WriteLine(" CLIIICKK");
       var client = Http; 

        var loginData = new { username, password };
        var response = await client.PostAsJsonAsync("http://localhost:5277/api/auth/login", loginData);

        if (response.IsSuccessStatusCode)
        {
            var result = await response.Content.ReadFromJsonAsync<TokenResult>();
            if (result is not null && !string.IsNullOrEmpty(result.Token))
            {
                JwtStore.Token = result.Token;
                await JS.InvokeVoidAsync("localStorage.setItem", "jwt", result.Token);
                Nav.NavigateTo("/", forceLoad: true);
            }
            else
            {
                errorMessage = "Tomt svar fr√•n servern.";
            }
        }
        else
        {
            errorMessage = "Felaktigt anv√§ndarnamn eller l√∂senord.";
        }
    }

    private class TokenResult
    {
        public string Token { get; set; } = string.Empty;
    }
}
